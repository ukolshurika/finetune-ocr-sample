# Finetune tesseract OCR
Тут собран пример дообучения модели Tesseract  для русского языка, так чтобы она распознавала дореволюционный язык с
ять, фета, i и т.д.

Важно! Команды написаны для командной строки Ubuntu. Для windows могут быть небольшие свои нюансы, но вполне возможно, что LLM их может исправить :) Ну или StackOverflow.

Основным материалом, которым я пользовалась чтобы получить удобо варимые результаты [тут](https://arcruz0.github.io/posts/finetuning-tess/).
Фактически это просто перевод и пример не с математическими символами, а дополнительными символами алфавита.


Алгоритм действий:
- берем страницы(вытаскиваем из pdf или если они уже картинками, оставляем).
- нарезаем страницы на отдельные строки с помощью `hocr`
- запускаем распознавание на текущей модели
- правим вручную данные с помощью утилиты [tesseractgt](https://github.com/arcruz0/tesseractgt)
- делим данные на два набора: для обучения и для верификации качества распознавания
- запускаем обучение.

## Подготовка обучающего сета данных


Качество дообучения модели напрямую зависит от данных. Для своей задачи( мне нужно было распознавать краеведческие дореводюционные печатные тексты конца XIX века). Для обучения я взяла из нескольких случайно выбранных книг страницы.

Для ряда задач можно найти уже [подготовленные данные](https://huggingface.co/datasets/nevmenandr/russian-old-orthography-ocr). Я же взяла книги из этого репозитория и дальше готовила по схеме, указанной ниже.

Книги были в pdf поэтому я использовала [`imagemagick`](https://imagemagick.org/script/download.php)

```
convert bogdanovich_p_i.dikij_chelovek.pdf[5-10] x_%03d.png
```

Указаны стриницы 5-10, но можно хоть всю книжку так разделить на страницы.
При конвертации сразу многих страниц возможно переполнение разрешенного объема памяти для imagemagic. Поэтому рекомендую обрабатывать небольшими блоками. При необходимости можно команду обернуть в цикл, чтобы она сама конвертила. У меня не было гиганского объема, поэтому этот шаг опущен.

Файлы переносим отдельную папку (`orus-ground-truth/`).
Суффикс `-ground-truth` в названии папки пригодится дальше, так как это стандарное название папки с данными дообученния. Префикс `orus` можно заменить на любой свой, так будет называться новая доученная модель.

Если вынесли в другое название, то его надо прописать в файле `split.sh`.
```
SOURCE="./ИМЯПАПКИ/"
```

Запускаем скрипт разделения изображения на строки и заранее распознаем базовой моделью. В нем зашита модель распознавания(у меня русскоязычная, для другой базовой модели нужно поправить скрипт). Для работы скрипта должен стоять [tesseract](https://github.com/tesseract-ocr/tesseract?tab=readme-ov-file#installing-tesseract) и [hocr-tools](https://github.com/ocropus/hocr-tools?tab=readme-ov-file#system-wide-with-pip).

```
./split.sh
```

Ставим [tesseractgt](https://github.com/arcruz0/tesseractgt), запускаем R и правим руками данные

```
Rscript run_fix_dataset.R
```

После разделяем данные на два набора: для обучения и валидации.
Валидировать необходимо, потому что иногла модели оказываются очень неустойчивы к изменениям и вместо улучшения качества распознавания можно наоборот получить ухудшение. Тогда нужно пересмотреть объем выбоки, её качество или другие параметры.

Сразу выделяем подмножество для валидации(см. _Валидация_), а остальные данные обрабатываем в соответствии с разделом _Обучение_.

Результаты и исходные примерные данные(без правок через R) есть в папке `preparation`. Там же файл со скриптом для запуска R.

## Обучение

Берём данные из репозитория  [tesstrain](https://github.com/tesseract-ocr/tesstrain). Это официальный репозиторий для обучения tesseract 5.

```
git clone https://github.com/tesseract-ocr/tesstrain.git
```
Запускаем базовую настройку.

```
cd tesstrain # wherever you saved this folder
make tesseract-langdata
```

Переносим папку `orus-ground-truth/`(тут может быть ваше название) в папку `data`. (здесь `location` нужно заменить на путь до папки из предыдущего шага, напоминаю, что часть данных полученных на предыдущем ша).

```
mv ~/location/orus-ground-truth data # should replace ~/location
```

Нужно скачать базовую предобученную модель, с которой начется работа. Для меня это была модель русского языка.

```
mkdir -p usr/share/tessdata
wget -P usr/share/tessdata https://github.com/tesseract-ocr/tessdata_best/raw/main/rus.traineddata
```

Запускаем обучение
```
make training MODEL_NAME=orus START_MODEL=rus FINETUNE_TYPE=Impact
```

Копируем полученную модель в ту папку, где лежит языки tesseract(для разныех систем путь может отличаться! Тут пример команды для Ubuntu 22.04). Чтобы узнать свой адрес можно в R выполнить такую команду `tesseract::tesseract_info()$datapath`. Это лишь один из способов.

```
sudo cp data/orus.traineddata /usr/share/tesseract-ocr/5/tessdata/
```


## Валидация
После того как модель прошла дообучение полезно посмотреть а насколько она точно умеет распознавать текст.
Проверка должна быть так же на размеченых данных, кроме того требуется разбивка на такие же изображения по формату.
Чтобы исключить ошибки связанные с разбиение на строки и т.п.

Код и файлы содержатся в папке  `validation`.

В папке `images/` лежат файлы, которые будет распознавать тестируемая модель. В папке `txt/` распознанные вручную данные. Это надо самостоятельно разложить после разделения массива данных.

Запуск:

```
python check.py
```

Название обученной модели зашито в [коде](https://github.com/ukolshurika/finetune-ocr-sample/blob/master/validation/check.py#L8). Нужно поменять `orus` на своё название обученной модели, чтобы заработала проверка.
Чтобы сравнить насколько улучшились показатели нужно вначале запустить с базовой моделью, а потом уже с дообученной.
При необходимости можно внести это в сам скрипт проверки.
